// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String?
  createdAt     DateTime       @default(now())
  settings      Json?
  levelEstimate LevelEstimate?
  reviews       Review[]
  lexemeStates  LexemeState[]
  cards         Card[]
}

model Lexeme {
  id           String        @id @default(cuid())
  lemma        String
  pos          String?
  freqRank     Int
  cefr         String        // A1..C2 seed label
  forms        String[]      // optional inflections
  notes        String?
  sentences    Sentence[]
  cards        Card[]
  lexemeStates LexemeState[]

  @@index([freqRank])
  @@index([cefr])
}

model Sentence {
  id             String   @id @default(cuid())
  targetLexemeId String
  textL2         String
  textL1         String   // translation
  cefr           String
  difficulty     Float    // 0..1 scaled
  tokens         String[] // optional tokenizer output
  source         String   // "llm" | "seed"
  targetForm     String?
  createdAt      DateTime @default(now())
  uniqueHash     String   @unique
  lexeme         Lexeme   @relation(fields: [targetLexemeId], references: [id])
  cards          Card[]
}

model Card {
  id             String   @id @default(cuid())
  userId         String
  sentenceId     String
  targetLexemeId String
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id])
  sentence       Sentence @relation(fields: [sentenceId], references: [id])
  lexeme         Lexeme   @relation(fields: [targetLexemeId], references: [id])
  reviews        Review[]
}

model Review {
  id          String   @id @default(cuid())
  userId      String
  lexemeId    String
  cardId      String
  rating      Int      // 1 again, 2 hard, 3 good, 4 easy
  reviewedAt  DateTime @default(now())
  stability   Float    // snapshot BEFORE update
  difficulty  Float
  elapsedDays Int
  user        User     @relation(fields: [userId], references: [id])
  card        Card     @relation(fields: [cardId], references: [id])

  @@index([userId, reviewedAt])
}

model LexemeState {
  userId     String
  lexemeId   String
  due        DateTime
  stability  Float
  difficulty Float
  reps       Int
  lapses     Int
  lastReview DateTime?
  suspended  Boolean  @default(false)
  user       User     @relation(fields: [userId], references: [id])
  lexeme     Lexeme   @relation(fields: [lexemeId], references: [id])

  @@id([userId, lexemeId])
  @@index([due])
}

model LevelEstimate {
  userId     String   @id
  cefrBand   String   // A1..C2
  vocabIndex Float    // 0..10
  confidence Float    // 0..1
  updatedAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
}
